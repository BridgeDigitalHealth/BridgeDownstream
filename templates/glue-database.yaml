AWSTemplateFormatVersion: '2010-09-09'
Description: Glue database and tables

Parameters:
  StudyName:
    Type: String
    Description: Study name, used to determine database name and S3 keyprefix

  BucketName:
    Type: String
    Description: Name of the S3 bucket storing the datasets

  JsonPrefix:
    Type: String
    Description: Prefix of the object keys
    Default: raw_json

Resources:

  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Sub '${StudyName}-db'

  AnswersTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_answers
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: distractions
              Type: boolean
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=answers/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: day,distractions,month,recordId,taskIdentifier,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  InfoTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_info
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: format
              Type: string
            - Name: appversion
              Type: string
            - Name: appname
              Type: string
            - Name: datafilename
              Type: string
            - Name: schemarevision
              Type: int
            - Name: phoneinfo
              Type: string
            - Name: files
              Type: array<struct<contentType:string,filename:string,timestamp:string>>
            - Name: item
              Type: string
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=info/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: appName,appVersion,dataFilename,day,files,format,item,month,phoneInfo,recordId,schemaRevision,taskIdentifier,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          SortColumns: []
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  MetadataTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_metadata
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: deviceinfo
              Type: string
            - Name: taskidentifier
              Type: string
            - Name: enddate
              Type: string
            - Name: devicetypeidentifier
              Type: string
            - Name: startdate
              Type: string
            - Name: rsdframeworkversion
              Type: string
            - Name: datagroups
              Type: string
            - Name: files
              Type: array<struct<filename:string,timestamp:string,contentType:string,identifier:string,stepPath:string>>
            - Name: appname
              Type: string
            - Name: appversion
              Type: string
            - Name: taskrunuuid
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
            - Name: substudymemberships
              Type: string
            - Name: healthcode
              Type: string
            - Name: createdon
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=metadata/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: appName,appVersion,createdon,dataGroups,day,deviceInfo,deviceTypeIdentifier,endDate,files,healthcode,month,recordId,rsdFrameworkVersion,startDate,substudymemberships,taskIdentifier,taskRunUUID,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  MicrophoneLevelsTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_microphone_levels
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          jsonPath: $[*]
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: uptime
              Type: double
            - Name: unit
              Type: string
            - Name: peak
              Type: double
            - Name: average
              Type: double
            - Name: steppath
              Type: string
            - Name: timeinterval
              Type: int
            - Name: timestamp
              Type: double
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=microphone_levels/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            jsonPath: $[*]
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: average,day,month,peak,recordId,stepPath,taskIdentifier,timeInterval,timestamp,unit,uptime,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  MotionTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_motion
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          jsonPath: $[*]
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: uptime
              Type: double
            - Name: timestamp
              Type: double
            - Name: timestampdate
              Type: string
            - Name: steppath
              Type: string
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
            - Name: x
              Type: double
            - Name: y
              Type: double
            - Name: sensortype
              Type: string
            - Name: z
              Type: double
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=motion/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            jsonPath: $[*]
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: day,month,recordId,sensorType,stepPath,taskIdentifier,timestamp,timestampDate,uptime,x,y,year,z
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  TaskDataTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_taskdata
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
          - Name: taskrunuuid
            Type: string
          - Name: schemaidentifier
            Type: string
          - Name: testversion
            Type: string
          - Name: stephistory
            Type: >-
              array<struct<instruction:boolean,wasInterrupted:boolean,startDate:string,type:string,identifier:string,endDate:string,response:string,score:int,failRuleSection:string,responseTime:int,stepGroup:string,anticipationError:int,se:double,theta:double,practice:boolean>>
          - Name: locale
            Type: string
          - Name: enddate
            Type: string
          - Name: scores
            Type: struct<nAnticipationLive:int,rawScore:int,accuracy:double,nAnticipationPractice:int,totalErrors:int,rateScore:double,finalTheta:double,startSE:int,finalSE:double,startTheta:double,itemCount:int>
          - Name: taskstatus
            Type: array<string>
          - Name: startdate
            Type: string
          - Name: taskname
            Type: string
          - Name: userinteractions
            Type: array<struct<controlEvent:array<string>,stepIdentifier:string,timestamp:string,userInteractionIdentifier:string,value:string>>
          - Name: steps
            Type: >-
              array<struct<wasInterrupted:boolean,position:int,endDate:string,startDate:string,identifier:string,type:string,instruction:boolean,response:string,score:int,failRuleSection:string,responseTime:int,stepGroup:string,anticipationError:int,se:double,theta:double,practice:boolean>>
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: int
          - Name: month
            Type: int
          - Name: day
            Type: int
          - Name: recordid
            Type: string
          - Name: consideredsteps
            Type: array<struct<randomNumber:double,identifier:string,exposure:double,administered:boolean>>
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=taskData/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: consideredSteps,day,endDate,locale,month,recordId,schemaIdentifier,scores,startDate,stepHistory,steps,taskIdentifier,taskName,taskRunUUID,taskStatus,testVersion,userInteractions,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  TaskResultTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_taskresult
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: stephistory
              Type: >-
                array<struct<asyncResults:array<struct<taskRunUUID:string,schemaIdentifier:string,testVersion:string,stepHistory:array<struct<instruction:boolean,wasInterrupted:boolean,startDate:string,type:string,identifier:string,endDate:string,response:string,score:int,failRuleSection:string,responseTime:int,stepGroup:string,anticipationError:int,se:double,theta:double,practice:boolean>>,locale:string,endDate:string,scores:struct<nAnticipationLive:int,rawScore:int,accuracy:double,nAnticipationPractice:int,totalErrors:int,rateScore:double,finalTheta:double,startSE:int,finalSE:double,startTheta:double,itemCount:int>,taskStatus:array<string>,startDate:string,taskName:string,userInteractions:array<struct<controlEvent:array<string>,stepIdentifier:string,timestamp:string,userInteractionIdentifier:string,value:string>>,steps:array<struct<wasInterrupted:boolean,position:int,endDate:string,startDate:string,identifier:string,type:string,instruction:boolean,response:string,score:int,failRuleSection:string,responseTime:int,stepGroup:string,anticipationError:int,se:double,theta:double,practice:boolean>>,answerType:struct<type:string>,value:boolean,type:string,identifier:string,consideredSteps:array<struct<randomNumber:double,identifier:string,exposure:double,administered:boolean>>>>,stepHistory:array<struct<wasInterrupted:boolean,interactions:array<struct<controlEvent:array<string>,stepIdentifier:string,timestamp:string,userInteractionIdentifier:string,value:string>>,startDate:string,endDate:string,identifier:string,type:string,instruction:boolean,response:string,score:int,failRuleSection:string,responseTime:int,skipToIdentifier:string,children:array<struct<wasInterrupted:boolean,interactions:array<struct<controlEvent:array<string>,stepIdentifier:string,timestamp:string,userInteractionIdentifier:string>>,startDate:string,endDate:string,identifier:string,type:string,instruction:boolean,practice:boolean>>,stepGroup:string,anticipationError:int,se:double,theta:double,practice:boolean>>,endDate:string,startDate:string,taskRunUUID:string,identifier:string,versionString:string,type:string,nodePath:array<string>,assessmentIdentifier:string,schemaIdentifier:string>>
            - Name: enddate
              Type: string
            - Name: startdate
              Type: string
            - Name: taskrunuuid
              Type: string
            - Name: identifier
              Type: string
            - Name: type
              Type: string
            - Name: nodepath
              Type: array<string>
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
            - Name: asyncresults
              Type: >-
                array<struct<weather:struct<clouds:int,humidity:int,provider:string,startDate:string,wind:struct<speed:double,degrees:int,gust:double>,seaLevelPressure:int,temperature:double,identifier:string,type:string>,airQuality:struct<category:struct<number:int,name:string>,provider:string,startDate:string,type:string,identifier:string,aqi:int>,startDate:string,type:string,identifier:string,endDate:string,contentType:string,startUptime:double,relativePath:string,answerType:struct<type:string>,value:boolean>>
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=taskResult/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: asyncResults,day,endDate,identifier,month,nodePath,recordId,startDate,stepHistory,taskIdentifier,taskRunUUID,type,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  WeatherTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_weather
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: weather
              Type: struct<clouds:int,humidity:int,provider:string,startDate:string,wind:struct<speed:double,degrees:int,gust:double>,seaLevelPressure:int,temperature:double,identifier:string,type:string>
            - Name: startdate
              Type: string
            - Name: type
              Type: string
            - Name: identifier
              Type: string
            - Name: enddate
              Type: string
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=weather/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: airQuality,day,endDate,identifier,month,recordId,startDate,taskIdentifier,type,weather,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

Outputs:

  DatabaseName:
    Value: !Ref GlueDatabase
    Export:
      Name: !Sub '${AWS::Region}-${AWS::StackName}-DatabaseName'
